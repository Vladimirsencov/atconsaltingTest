DROP TABLE IF EXISTS USERS;
DROP TABLE IF EXISTS BOOKS;
DROP TABLE IF EXISTS USER_ROLES;

CREATE TABLE USERS (
  ID       BIGINT AUTO_INCREMENT PRIMARY KEY,
  EMAIL    VARCHAR(255) UNIQUE,
  USERNAME VARCHAR(255) UNIQUE NOT NULL,
  PASSWORD VARCHAR(63)
);

CREATE TABLE BOOKS (
  ID          BIGINT AUTO_INCREMENT PRIMARY KEY,
  ISBN        VARCHAR(120) UNIQUE      NOT NULL,
  TITLE       VARCHAR(120)             NOT NULL,
  AUTHOR_NAME VARCHAR(120)             NOT NULL,
  READER_NAME VARCHAR(120) DEFAULT NULL,
  FOREIGN KEY (READER_NAME) REFERENCES USERS (USERNAME)
  ON DELETE SET NULL ON UPDATE CASCADE
);

CREATE TABLE USER_ROLES (
  USER_ID   BIGINT       NOT NULL,
  USER_NAME VARCHAR(127) NOT NULL,
  ROLE      VARCHAR(60)  NOT NULL,
  CONSTRAINT IDX_USER_ROLE UNIQUE (USER_NAME, ROLE),
  FOREIGN KEY (USER_NAME) REFERENCES USERS (USERNAME) ON DELETE CASCADE ON UPDATE CASCADE,
  FOREIGN KEY (USER_ID) REFERENCES USERS (ID) ON DELETE CASCADE
);
